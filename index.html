<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machine Inspection Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#f1f5f9;--card:#fff;--muted:#6b7280;--green:#2f9e44;--red:#ef4444;--accent:#123a66}
    body{font-family:Arial, sans-serif;margin:0;background:var(--bg);padding:20px}
    .wrap{max-width:1200px;margin:auto}
    .topbar{background:var(--accent);color:#fff;padding:18px;border-radius:10px}
    .card-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-top:20px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .kpi-value{font-size:34px;font-weight:bold;margin-top:5px}
    .kpi-label{color:var(--muted)}
    .main{display:grid;grid-template-columns:1fr 400px;gap:20px;margin-top:22px}
    .panel{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th{background:#eef;padding:10px;text-align:left}
    .table td{padding:10px;border-bottom:1px solid #eee}
    .status{padding:4px 10px;border-radius:8px;color:#fff;font-weight:bold}
    .status.pass{background:var(--green)}
    .status.fail{background:var(--red)}
  </style>
</head>
<body>

<div class="wrap">

  <div class="topbar"><h2>Machine Inspection Dashboard</h2></div>

  <div style="margin-top:14px; display:flex; gap:10px; align-items:center;">
      <label>เลือกชีต:</label>
      <select id="sheetSelect" style="padding:8px; border-radius:6px;">
        <option value="หลังการใช้งาน">หลังการใช้งาน</option>
        <option value="ทุก 4 เดือน">ทุก 4 เดือน</option>
        <option value="รายปี">รายปี</option>
      </select>
      <button id="btnLoad" style="padding:8px 12px; background:#0b64a3; color:white; border:none; border-radius:6px; cursor:pointer;">โหลดข้อมูล</button>
      <span id="msg" style="color:var(--muted);"></span>
  </div>

  <div class="card-grid">
    <div class="card"><div class="kpi-label">Total Inspections</div><div id="totalIns" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-label">Total Passed</div><div id="totalPass" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-label">Total Failed</div><div id="totalFail" class="kpi-value">—</div></div>
    <div class="card"><div class="kpi-label">Pass Rate</div><div id="passRate" class="kpi-value">—</div></div>
  </div>

  <div class="main">

    <div>
      <div class="panel">
        <h3>Inspection Pass/Fail Ratio</h3>
        <canvas id="pieChart" height="200"></canvas>
      </div>

      <div class="panel" style="margin-top:20px;">
        <h3>Inspection Summary</h3>
        <table class="table" id="summaryTable">
          <thead><tr><th>Inspection No.</th><th>Date/Time</th><th>Passed</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div>
      <div class="panel">
        <h3>Pass/Fail Count by Item</h3>
        <canvas id="barChart" height="400"></canvas>
      </div>
    </div>

  </div>

</div>

<script>

// ใช้ลิงค์ output=csv ซึ่ง fetch ได้จริง
const API_URL = "https://script.google.com/macros/s/AKfycbwCxcc5pTD08dGYOw1Qa3Xnb2XgLRoY4XcKaGyzMmM3QS2VgWkl4mj0WuKKtaJYL0MI/exec";

function parseCSV(text){
  return text.trim().split(/\r?\n/).map(row => row.split(","));
}

let pieChart=null, barChart=null;

document.getElementById("btnLoad").addEventListener("click", load);

async function load(){
  const sheet = document.getElementById("sheetSelect").value;
  document.getElementById("msg").textContent = "กำลังโหลด...";

  try{
      const res = await fetch(`${API_URL}?sheet=${encodeURIComponent(sheet)}`);
      const json = await res.json();
      const csv = json.data;

      const headers = csv[0].map(h=>h.toLowerCase());
      const rows = csv.slice(1);

      let total=0, pass=0, fail=0;
      const itemCounts = {};
      const summary=[];

      rows.forEach(r=>{
        total++;

        const obj={};
        headers.forEach((h,i)=> obj[h] = r[i] || "");

        let result = (obj["result"]||obj["status"]||r[r.length-1]||"").toLowerCase();
        const isPass = result.includes("pass") || result.includes("ผ่าน") || result.includes("ok");

        if(isPass) pass++; else fail++;

        const item = obj["item"] || obj["inspection item"] || r[2] || "";
        if(!itemCounts[item]) itemCounts[item] = {pass:0, fail:0};
        if(isPass) itemCounts[item].pass++; else itemCounts[item].fail++;

        summary.push({
          ins: obj["inspection no"] || r[0],
          dt: obj["date/time"] || obj["datetime"] || r[1],
          isPass: isPass,
          state: isPass? "Pass":"Fail"
        });
      });

      document.getElementById("totalIns").textContent = total;
      document.getElementById("totalPass").textContent = pass;
      document.getElementById("totalFail").textContent = fail;
      document.getElementById("passRate").textContent = Math.round(pass/total*100)+"%";

      const tbody = document.querySelector("#summaryTable tbody");
      tbody.innerHTML = "";
      summary.slice(0,8).forEach(r=>{
        tbody.innerHTML += `
          <tr>
            <td>${r.ins}</td>
            <td>${r.dt}</td>
            <td>${r.isPass?1:0}</td>
            <td><span class="status ${r.isPass? "pass":"fail"}">${r.state}</span></td>
          </tr>`;
      });

      const pieCtx = document.getElementById("pieChart").getContext("2d");
      if(pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx,{
        type:"doughnut",
        data:{ labels:["Pass","Fail"], datasets:[{ data:[pass,fail], backgroundColor:["#2f9e44","#ef4444"] }] },
        options:{ cutout:"70%", plugins:{legend:{display:false}} }
      });

      const labels = Object.keys(itemCounts);
      const passV = labels.map(k=>itemCounts[k].pass);
      const failV = labels.map(k=>itemCounts[k].fail);

      const barCtx = document.getElementById("barChart").getContext("2d");
      if(barChart) barChart.destroy();
      barChart = new Chart(barCtx,{
        type:"bar",
        data:{ labels:labels, datasets:[
          {label:"Passed", data:passV, backgroundColor:"#2f9e44"},
          {label:"Failed", data:failV, backgroundColor:"#ef4444"}
        ]},
        options:{ indexAxis:"y", scales:{x:{beginAtZero:true}} }
      });

      document.getElementById("msg").textContent = "";

  } catch(e){
    document.getElementById("msg").textContent = "โหลดข้อมูลไม่ได้ — ตรวจสอบชื่อชีตใน Apps Script";
  }
}

window.addEventListener("load", load);("load", load);

</script>

</body>
</html>
