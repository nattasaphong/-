<!-- Dashboard-style index.html — preserves original UI while fetching from Google Sheets -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machine Inspection Dashboard</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#f1f5f9;--card:#fff;--muted:#6b7280;--accent:#123a66;--green:#2f9e44;--red:#ef4444}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:linear-gradient(180deg,#eef4f9 0%,var(--bg) 100%);padding:28px}
    .wrap{max-width:1200px;margin:0 auto}
    .topbar{background:var(--accent);color:#fff;border-radius:10px;padding:20px 28px;display:flex;align-items:center;justify-content:space-between}
    .title{font-size:20px;font-weight:700}
    .card-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px;margin-top:22px}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 2px 8px rgba(15,23,42,0.06)}
    .kpi-value{font-size:36px;font-weight:700;margin-top:6px}
    .kpi-label{color:var(--muted);font-size:14px}
    .main{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:18px}
    .panel{background:var(--card);padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(15,23,42,0.04)}
    .h{font-weight:600;margin-bottom:12px}
    .legend{display:flex;gap:12px;align-items:center;margin-top:12px}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th{background:#fbfdff;padding:10px;border-bottom:1px solid #eef2f7;text-align:left;font-weight:600}
    .table td{padding:12px;border-bottom:1px solid #f1f5f9}
    .status{padding:6px 10px;border-radius:8px;color:#fff;font-weight:600;font-size:13px}
    .status.pass{background:var(--green)}
    .status.fail{background:var(--red)}
    /* responsive */
    @media (max-width:1000px){.card-grid{grid-template-columns:repeat(2,1fr)}.main{grid-template-columns:1fr}}
    @media (max-width:520px){.card-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Machine Inspection Dashboard</div>
      <div style="opacity:.9">&nbsp;</div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:14px">
      <label for="sheetSelect">เลือกชีต:</label>
      <select id="sheetSelect" style="padding:8px;border-radius:6px;border:1px solid #e6edf3">
        <option value="1693819937">Sheet A</option>
        <option value="1885388831">Sheet B</option>
        <option value="1533454341">Sheet C</option>
      </select>
      <button id="btnLoad" style="padding:8px 12px;border-radius:6px;border:none;background:#0b64a3;color:#fff;cursor:pointer">โหลดข้อมูล</button>
      <div id="msg" style="margin-left:8px;color:var(--muted)"></div>
    </div>

    <div class="card-grid">
      <div class="card">
        <div class="kpi-label">Total Inspections</div>
        <div id="totalIns" class="kpi-value">—</div>
      </div>
      <div class="card">
        <div class="kpi-label">Total Passed</div>
        <div id="totalPass" class="kpi-value">—</div>
      </div>
      <div class="card">
        <div class="kpi-label">Total Failed</div>
        <div id="totalFail" class="kpi-value">—</div>
      </div>
      <div class="card">
        <div class="kpi-label">Pass Rate</div>
        <div id="passRate" class="kpi-value">—</div>
      </div>
    </div>

    <div class="main">
      <div>
        <div class="panel">
          <div class="h">Inspection Pass/Fail Ratio</div>
          <canvas id="pieChart" width="400" height="260"></canvas>
          <div class="legend">
            <div style="display:flex;align-items:center;gap:8px"><span class="dot" style="background:var(--green)"></span> Passed</div>
            <div style="display:flex;align-items:center;gap:8px"><span class="dot" style="background:var(--red)"></span> Failed</div>
          </div>
        </div>

        <div class="panel" style="margin-top:18px">
          <div class="h">Inspection Summary</div>
          <table class="table" id="summaryTable">
            <thead>
              <tr><th>Inspection No.</th><th>Date / Time</th><th>Passed</th><th>State</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div>
        <div class="panel">
          <div class="h">Pass/Fail Count by Inspection Item</div>
          <canvas id="barChart" width="400" height="460"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Spreadsheet ID (from your provided urls)
    const SSID = '1oTX7WQk1ru4WCI6Qo_ZCRY4L4stnfMlBvgeRNUK5KFk';

    function buildSheetURL(gid){
      // uses gviz/tq JSON output
      return `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:json&gid=${gid}`;
    }

    // parse gviz response
    function parseGviz(text){
      // strip leading chars and trailing );
      const json = JSON.parse(text.substring(text.indexOf('{')));
      return json.table;
    }

    // helpers to safely get cell value
    function cellVal(cell){
      if(!cell) return '';
      if(cell.v === undefined) return '';
      return cell.v;
    }

    // Chart instances
    let pieChart=null, barChart=null;

    document.getElementById('btnLoad').addEventListener('click', load);

    async function load(){
      const gid = document.getElementById('sheetSelect').value;
      const url = buildSheetURL(gid);
      document.getElementById('msg').textContent = 'กำลังโหลด...';

      try{
        const res = await fetch(url);
        const txt = await res.text();
        const table = parseGviz(txt);

        // assume sheet columns include: inspection_no, datetime, item_name, result (Pass/Fail) or numeric
        const rows = table.rows || [];

        // compute summary
        let total = rows.length;
        let passCount = 0;
        let failCount = 0;

        // item counts (by item_name) -> {item: {pass: n, fail: n}}
        const itemCounts = {};

        // build summary table rows array (show latest 10)
        const summaryRows = [];

        for(let r of rows){
          // try flexible mapping: look for possible columns by label if available
          // We'll use first columns by position: [0]=ins_no, [1]=datetime, [2]=passed_count or item/result
          const cols = table.cols.map(c=> (c.label||'').toLowerCase());

          const insNo = cellVal(r.c[0]);
          const dt = cellVal(r.c[1]);

          // determine pass/fail for row: if there is a column named 'result' or last col contains text
          let result = '';
          const labelIndex = cols.indexOf('result');
          if(labelIndex !== -1){ result = (r.c[labelIndex] && r.c[labelIndex].v) || ''; }
          else {
            // fallback: if there's a numeric passed column (e.g., number of passed items), and total > passed then some fail
            // try find 'passed' label
            const pIndex = cols.indexOf('passed');
            const tIndex = cols.indexOf('total');
            if(pIndex !== -1){
              const p = Number(cellVal(r.c[pIndex])) || 0;
              const t = tIndex !== -1 ? (Number(cellVal(r.c[tIndex]))||0) : 0;
              if(t>0){ result = (p===t) ? 'Pass' : (p<t? 'Fail' : 'Pass'); }
              else result = p>0 ? 'Pass' : '';
            }
            // else try last column text
            if(!result){
              const last = r.c[r.c.length-1];
              if(last && typeof last.v === 'string'){
                const txtv = last.v.toString().toLowerCase();
                if(txtv.includes('pass')||txtv.includes('ผ่าน')||txtv.includes('ok')) result = 'Pass';
                else if(txtv.includes('fail')||txtv.includes('ไม่ผ่าน')||txtv.includes('fail')) result = 'Fail';
              }
            }
          }

          // if still empty, skip classification
          if(result.toString().toLowerCase().includes('f')) failCount++;
          else if(result.toString().toLowerCase().includes('p')) passCount++;

          // item name guess: try column label 'item' or 'inspection item' else col[2]
          let itemName = '';
          const itemIndex = cols.findIndex(c=> c.includes('item')||c.includes('รายการ')||c.includes('inspection'));
          if(itemIndex !== -1) itemName = cellVal(r.c[itemIndex]);
          else itemName = cellVal(r.c[2]) || '';

          if(itemName){
            if(!itemCounts[itemName]) itemCounts[itemName] = {pass:0, fail:0};
            if(result.toString().toLowerCase().includes('f')) itemCounts[itemName].fail++;
            else if(result.toString().toLowerCase().includes('p')) itemCounts[itemName].pass++;
          }

          summaryRows.push({insNo, dt, passed: result.toString().toLowerCase().includes('p') ? 'Yes' : 'No', state: result});
        }

        // if rows lacked any explicit pass/fail, try infer: if some rows had numeric passed values
        if(passCount+failCount === 0){
          // attempt to use column named 'passed' as counts
          const cols = table.cols.map(c=> (c.label||'').toLowerCase());
          const pIndex = cols.indexOf('passed');
          const tIndex = cols.indexOf('total');
          if(pIndex!==-1){
            for(let r of rows){
              const p = Number(cellVal(r.c[pIndex]))||0;
              const t = tIndex!==-1 ? (Number(cellVal(r.c[tIndex]))||0) : 0;
              passCount += p;
              if(t) failCount += (t - p);
            }
            total = passCount + failCount;
          }
        }

        // update KPIs
        document.getElementById('totalIns').textContent = total || 0;
        document.getElementById('totalPass').textContent = passCount || 0;
        document.getElementById('totalFail').textContent = failCount || 0;
        const rate = total? Math.round((passCount/total)*100) : 0;
        document.getElementById('passRate').textContent = rate + '%';

        // populate summary table (show up to 8 latest)
        const tbody = document.querySelector('#summaryTable tbody');
        tbody.innerHTML = '';
        const showRows = summaryRows.slice(0,8);
        showRows.forEach(r =>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.insNo||''}</td><td>${r.dt||''}</td><td>${r.passed==='Yes'?1:0}</td><td><span class='status ${r.state && r.state.toString().toLowerCase().includes('f')? 'fail':'pass'}'>${r.state||'Unknown'}</span></td>`;
          tbody.appendChild(tr);
        });

        // build pie chart
        const pieCtx = document.getElementById('pieChart').getContext('2d');
        const pieData = [passCount||0, failCount||0];
        if(pieChart) pieChart.destroy();
        pieChart = new Chart(pieCtx, {
          type:'doughnut',
          data:{labels:['Passed','Failed'],datasets:[{data:pieData,backgroundColor:['#2f9e44','#ef4444']}]},
          options:{plugins:{legend:{display:false}},cutout:'70%'}
        });

        // build bar chart from itemCounts
        const labels = Object.keys(itemCounts);
        const passValues = labels.map(l=> itemCounts[l].pass || 0);
        const failValues = labels.map(l=> itemCounts[l].fail || 0);

        const barCtx = document.getElementById('barChart').getContext('2d');
        if(barChart) barChart.destroy();
        barChart = new Chart(barCtx, {
          type:'bar',
          data:{labels:labels, datasets:[{label:'Passed',data:passValues,backgroundColor:'#2f9e44'},{label:'Failed',data:failValues,backgroundColor:'#ef4444'}]},
          options:{indexAxis:'y',responsive:true,scales:{x:{beginAtZero:true}},plugins:{legend:{position:'bottom'}}}
        });

        document.getElementById('msg').textContent = '';
      }
      catch(err){
        console.error(err);
        document.getElementById('msg').textContent = 'โหลดข้อมูลไม่ได้ — ตรวจสอบว่าไฟล์ Google Sheets ถูกแชร์เป็น "Anyone with the link" หรือ "Publish to web"';
      }
    }

    // auto-load first sheet on open
    window.addEventListener('load', ()=>{load();});
  </script>
</body>
</html>